<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.8.0"></script>
</head>
<body>
<img src="img.jpg" id="input">
<canvas id="translation"></canvas>
<script>

    function conv(x, cw, n_filters, strides, padding='valid') {
        const indepth = x.shape[3];
        const kernel = tf.variable(tf.randomNormal([cw, cw, indepth, n_filters]));
        //const bias
        return tf.conv2d(x, kernel, strides, padding);
    }

    function resblock(x, n_filters) {
        let net = x;

        net = conv(net, 3, n_filters, 1, 'same');
        net = tf.relu(net);

        net = conv(net, 3, n_filters, 1, 'same');

        return tf.add(x, net);
    }

    function deconv(x, cw, n_filters, strides) {
        const [batch_size, h, w, indepth] = x.shape;
        const output_shape = [batch_size, h*2, w*2, n_filters];

        const kernel = tf.variable(tf.randomNormal([cw, cw, n_filters, indepth]));
        //const bias
        return tf.conv2dTranspose(x, kernel, output_shape, strides, 'same')
    }

    //const img = tf.randomNormal([1, 216, 176, 3]);
    const img = tf.fromPixels(document.getElementById("input"), 3).toFloat().expandDims(0);

    const relu = tf.relu;
    const norm = x => x;  // TODO: Layernorm.

    // Cycle GAN generator graph.
    let net = img;
    net = relu(norm(conv(net, 7, 32, 1)));
    net = relu(norm(conv(net, 3, 64, 2)));
    net = relu(norm(conv(net, 3, 128, 2)));
    for (let i = 0; i < 6; i++) {
        net = resblock(net, 128);
    }
    net = relu(norm(deconv(net, 3, 64, 2)));
    net = relu(norm(deconv(net, 3, 32, 2)));
    net = tf.tanh(conv(net, 7, 3, 1));

    const translated_img = net
        .add(tf.scalar(1.0))
        .div(tf.scalar(2.0))
        .mul(tf.scalar(255.0));

    const [_, h, w, __] = translated_img.shape;

    const canvas = document.getElementById("translation");
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext("2d");

    const rgb = translated_img.dataSync();
    const imageData = ctx.createImageData(w, h);
    for (let i = 0; i < w * h; i++) {
        const j = i * 3;
        imageData.data[i] = rgb[j];
        imageData.data[i+1] = rgb[j+1];
        imageData.data[i+2] = rgb[j+2];
        imageData.data[i+3] = 255;
    }
    console.log(imageData);
    //ctx.putImageData(imageData, 0, 0);

</script>
</body>
</html>